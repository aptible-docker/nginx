<% if ENV['PROTOCOL'] == 'tcp' %>
stream {
  <% (ENV['UPSTREAM_SERVER_PORTS'] || '').split(',').each do |port| %>
    <% if ENV["UPSTREAM_SERVERS_#{port}"] %>
    upstream containers_<%= port %> {
      <% ENV["UPSTREAM_SERVERS_#{port}"].split(',').each do |server| %>
      server <%= server %>;
      <% end %>
    }
    <% end %>

    error_log /proc/self/fd/1;

    server {
      listen <%= port %>;
      <% if ENV["UPSTREAM_SERVERS_#{port}"] %>
      proxy_pass containers_<%= port %>;
      <% end %>
    }
  <% end %>
}
<% end %>
